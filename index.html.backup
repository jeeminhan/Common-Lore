<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Common Lore | ISM Conversational Playing Cards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#1a237e',
                        cream: '#f5f5dc',
                        spade: '#1565c0',
                        heart: '#c62828',
                        diamond: '#f9a825',
                        club: '#2e7d32',
                        purple: '#7b1fa2',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap');

        .font-display {
            font-family: 'Playfair Display', serif;
        }

        .font-body {
            font-family: 'Inter', sans-serif;
        }

        .glow {
            box-shadow: 0 0 30px rgba(123, 31, 162, 0.3);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .pulse-subtle {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>

<body class="bg-navy min-h-screen font-body relative">
    <div id="app"></div>

    <!-- Feedback Button (Fixed) -->
    <button onclick="openFeedback()" id="feedback-toggle"
        class="fixed bottom-6 right-6 z-40 bg-purple/90 backdrop-blur-sm text-white px-4 py-3 rounded-full shadow-lg hover:bg-purple transition-all transform hover:scale-105 flex items-center gap-3 border border-white/20">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
        </svg>
        <span class="text-sm font-semibold whitespace-nowrap">Give Feedback</span>
    </button>

    <!-- Feedback Modal -->
    <div id="feedback-modal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-navy/80 backdrop-blur-md hidden fade-in">
        <div class="bg-cream w-full max-w-2xl h-[80vh] rounded-3xl overflow-hidden relative shadow-2xl flex flex-col">
            <div class="p-4 bg-white border-b flex justify-between items-center">
                <h3 class="font-display font-bold text-navy text-lg">Common Lore Feedback</h3>
                <button onclick="closeFeedback()" class="text-gray-400 hover:text-navy p-1 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-hidden relative">
                <div id="modal-loading" class="absolute inset-0 flex items-center justify-center bg-cream z-10">
                    <div class="w-8 h-8 border-4 border-purple border-t-transparent rounded-full animate-spin"></div>
                </div>
                <iframe id="feedback-iframe"
                    src="https://docs.google.com/forms/d/e/1FAIpQLSdPBg6plGCeigKzhRRuNzFqRxxlGmnlKr9OWdK1tHP8mi93mg/viewform?embedded=true"
                    class="w-full h-full border-0"
                    onload="document.getElementById('modal-loading').classList.add('hidden')">Loading…</iframe>
            </div>
            <div id="auto-popup-note" class="p-3 bg-purple text-white text-xs text-center hidden">
                Thank you for playing Common Lore! We'd love to hear your thoughts.
            </div>
        </div>
    </div>

    <script>
        // ============== CARD DATA ==============
        const SUITS = {
            spades: {
                name: "The Career Bridge",
                theme: "Professional & Vision",
                symbol: "♠",
                color: "spade",
                bgLight: "bg-blue-50",
                action: { title: "The Referral", text: "Nominate another player to answer a question of your choice from your hand." },
                cards: [
                    { rank: "K", text: "If you could give a speech to the leaders of your industry today, what truth would you want them to hear?" },
                    { rank: "Q", text: "How could your future career be used to serve or \"bless\" your community back home one day?" },
                    { rank: "J", text: "What does \"success\" look like to your parents, and how does that compare to your own definition?" },
                    { rank: "10", text: "When you return home, what is the first \"big problem\" you hope your new expertise will help solve?" },
                    { rank: "9", text: "Is there someone you are hoping to connect with professionally right now? How can we help?" },
                    { rank: "8", text: "Who is a leader from your home country that you would want to introduce to your American friends?" },
                    { rank: "7", text: "If visas and paperwork weren't an issue, what would be your \"dream first step\" after graduation?" },
                    { rank: "6", text: "What is a strength you've discovered in yourself only after moving to a different country?" },
                    { rank: "5", text: "How do your personal values or faith change the kind of company you'd be willing to work for?" },
                    { rank: "4", text: "What is the most surprising difference between an interview back home vs. an interview here?" },
                    { rank: "3", text: "What's the hardest part about translating your life story into a one-page U.S. resume?" },
                    { rank: "2", text: "What was your very first \"dream job\" when you were a child?" },
                ]
            },
            hearts: {
                name: "The Hospitality Bridge",
                theme: "Oikos & Belonging",
                symbol: "♥",
                color: "heart",
                bgLight: "bg-red-50",
                action: { title: "The Shared Table", text: "Everyone at the table answers the last question asked." },
                cards: [
                    { rank: "K", text: "What is a tradition from your family that you hope to pass on to your own children one day?" },
                    { rank: "Q", text: "If you could \"teleport\" one person from home to sit at this table for an hour, who would it be?" },
                    { rank: "J", text: "What makes a place feel like \"home\" to you—is it the people, the smells, or a feeling?" },
                    { rank: "10", text: "In what specific way do you want to be a blessing to your \"household\" (oikos) right now?" },
                    { rank: "9", text: "What is the most \"un-homelike\" thing about living in an American dorm or apartment?" },
                    { rank: "8", text: "How can friends here best support you when you are feeling the \"weight\" of being away?" },
                    { rank: "7", text: "What is a childhood story or \"fable\" your parents told you that you'll never forget?" },
                    { rank: "6", text: "How do people in your country usually welcome a stranger into their home?" },
                    { rank: "5", text: "If I were to pray for your family today, what is the \"big hope\" or \"big worry\" on their hearts?" },
                    { rank: "4", text: "Who in your family was your biggest champion in getting you here? What did they sacrifice?" },
                    { rank: "3", text: "What is a \"ritual\" from home (like making tea or a morning routine) that you keep alive here?" },
                    { rank: "2", text: "What is the first thing you want to eat the moment you land in your home country?" },
                ]
            },
            diamonds: {
                name: "The Cultural Bridge",
                theme: "Identity & Wisdom",
                symbol: "♦",
                color: "diamond",
                bgLight: "bg-amber-50",
                action: { title: "The Translator", text: "Choose a player to explain their answer using a metaphor or a word from your native language." },
                cards: [
                    { rank: "K", text: "What does \"Honor\" mean to you, and how do you show it to others in a culture that feels very \"informal\"?" },
                    { rank: "Q", text: "How does your community back home celebrate the biggest milestones of life?" },
                    { rank: "J", text: "How do you decide which parts of American culture to \"adopt\" and which to \"reject\"?" },
                    { rank: "10", text: "What do people here often get wrong about your culture that you'd love to correct?" },
                    { rank: "9", text: "How does your family's faith or worldview shape the way you handle conflict?" },
                    { rank: "8", text: "What's a historical event from your nation that you wish every American knew about?" },
                    { rank: "7", text: "In your culture, who is considered a \"hero,\" and what does that tell us about what your people value?" },
                    { rank: "6", text: "What is the \"Good Life\"? What kind of music or songs make you think of it?" },
                    { rank: "5", text: "How has being in the U.S. changed the way you look at your own home country?" },
                    { rank: "4", text: "If you could give every American one \"memory\" from your childhood to help them understand your culture, what would it be?" },
                    { rank: "3", text: "What is a piece of \"grandmotherly wisdom\" or a proverb you think about when life gets hard?" },
                    { rank: "2", text: "What is one thing Americans do that they think is polite, but feels \"off\" to you?" },
                ]
            },
            clubs: {
                name: "The Scientific Bridge",
                theme: "Creation & Wonder",
                symbol: "♣",
                color: "club",
                bgLight: "bg-green-50",
                action: { title: "The Experiment", text: "You may \"veto\" a question and draw a new card, or \"challenge\" another player to answer your card instead." },
                cards: [
                    { rank: "K", text: "If you could ask the Creator of the Universe one scientific question, what would it be?" },
                    { rank: "Q", text: "How do you personally balance the \"seen\" physical world with the \"unseen\" spiritual one?" },
                    { rank: "J", text: "In your research, have you ever found a pattern that felt \"too perfect\" to be an accident?" },
                    { rank: "10", text: "If you had unlimited funding to help \"the least of these\" back home using your major, where would you start?" },
                    { rank: "9", text: "What is the toughest ethical choice a scientist in your field has to make?" },
                    { rank: "8", text: "Do you find that people at your university treat \"Science\" like it's a religion?" },
                    { rank: "7", text: "How could your specific expertise be used as a \"platform\" for doing good globally?" },
                    { rank: "6", text: "If the universe was designed by an Artist, what does your field of study reveal about the Artist's personality?" },
                    { rank: "5", text: "Have you ever felt a sense of \"awe\" or \"worship\" while looking at a complex equation or microscope?" },
                    { rank: "4", text: "What is the biggest scientific or technical challenge your home country is currently facing?" },
                    { rank: "3", text: "Do you think science and faith are two different languages, or are they telling the same story?" },
                    { rank: "2", text: "What is the most \"beautiful\" or \"elegant\" thing you've learned about the universe lately?" },
                ]
            }
        };

        // ============== APP STATE ==============
        let state = {
            view: 'home',
            deck: [],
            instructionsTab: 'rules',
            currentCard: null,
            discardPile: [],
            players: [],
            currentPlayerIndex: 0,
            sharedLore: [],
            feedbackPopupShown: false,
            timerStarted: false
        };

        // ============== HELPERS ==============
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function buildDeck() {
            const deck = [];
            Object.entries(SUITS).forEach(([suitKey, suit]) => {
                deck.push({
                    suit: suitKey,
                    rank: 'A',
                    isAction: true,
                    title: suit.action.title,
                    text: suit.action.text,
                    symbol: suit.symbol,
                    color: suit.color
                });
                suit.cards.forEach(card => {
                    deck.push({
                        suit: suitKey,
                        rank: card.rank,
                        isAction: false,
                        text: card.text,
                        symbol: suit.symbol,
                        color: suit.color
                    });
                });
            });
            return shuffle(deck);
        }

        function getSuitColorClass(color, type = 'bg') {
            const colors = {
                spade: { bg: 'bg-spade', text: 'text-spade', border: 'border-spade' },
                heart: { bg: 'bg-heart', text: 'text-heart', border: 'border-heart' },
                diamond: { bg: 'bg-diamond', text: 'text-diamond', border: 'border-diamond' },
                club: { bg: 'bg-club', text: 'text-club', border: 'border-club' },
            };
            return colors[color]?.[type] || 'bg-purple';
        }

        // ============== RENDER FUNCTIONS ==============
        function render() {
            const app = document.getElementById('app');
            switch (state.view) {
                case 'home': app.innerHTML = renderHome(); break;
                case 'play': app.innerHTML = renderPlay(); break;
                case 'instructions': app.innerHTML = renderInstructions(); break;
                case 'closing': app.innerHTML = renderClosing(); break;
            }
        }

        function renderHome() {
            return `
    <div class="min-h-screen flex flex-col">
        <div class="flex-1 flex items-center justify-center p-6">
            <div class="max-w-4xl w-full">
                <div class="bg-cream rounded-3xl p-8 md:p-12 shadow-2xl glow">
                    <div class="text-center mb-8">
                        <h1 class="font-display text-4xl md:text-6xl font-bold text-navy mb-4">Common Lore</h1>
                        <p class="text-xl md:text-2xl text-gray-600">ISM Conversational Playing Cards</p>
                    </div>

                    <div class="flex justify-center gap-2 md:gap-4 mb-10 overflow-hidden">
                        ${['spade', 'heart', 'diamond', 'club'].map((color, i) => `
                            <div class="w-16 md:w-24 h-24 md:h-36 rounded-xl ${getSuitColorClass(color)} shadow-lg transform hover:scale-105 transition-transform flex items-center justify-center"
                                 style="transform: rotate(${(i - 1.5) * 8}deg)">
                                <span class="text-white text-3xl md:text-5xl">${['♠', '♥', '♦', '♣'][i]}</span>
                            </div>
                        `).join('')}
                    </div>

                    <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
                        Weave individual stories into a <strong>"Shared Lore"</strong> by discovering the universal truths
                        that connect our careers, cultures, homes, and wonders.
                    </p>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="startGame()" class="px-8 py-4 bg-purple text-white rounded-xl font-semibold text-lg hover:bg-purple/90 transition-colors pulse-subtle">
                            Draw a Card
                        </button>
                        <button onclick="navigate('instructions')" class="px-8 py-4 bg-white border-2 border-navy text-navy rounded-xl font-semibold text-lg hover:bg-navy hover:text-white transition-colors">
                            How to Play
                        </button>
                    </div>

                    <div class="flex justify-center flex-wrap gap-6 mt-6">
                        <button onclick="state.instructionsTab='facilitator'; navigate('instructions')" class="text-gray-500 hover:text-purple transition-colors text-sm">
                            Facilitator's Guide
                        </button>
                        <button onclick="openFeedback()" class="text-gray-500 hover:text-purple transition-colors text-sm">
                            Leave Feedback
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center py-6 text-white/60 text-sm">
            <p>Frontier Commons Innovation Lab • International Friendships, Inc.</p>
        </footer>
    </div>`;
        }

        function renderPlay() {
            const card = state.currentCard;
            const remaining = state.deck.length;
            const discarded = state.discardPile.length;

            return `
    <div class="min-h-screen flex flex-col p-4 md:p-6">
        <div class="flex justify-between items-center mb-6">
            <button onclick="navigate('home')" class="text-white/70 hover:text-white flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back
            </button>
            <div class="flex gap-4 text-white/70 text-sm">
                <span>Deck: ${remaining}</span>
                <span>Shared: ${discarded}</span>
            </div>
        </div>

        <div class="flex-1 flex items-center justify-center">
            ${card ? renderCurrentCard(card) : renderDeckStack()}
        </div>

        <div class="mt-6 flex flex-col items-center gap-4">
            ${card ? `
                <div class="flex gap-4">
                    <button onclick="answerCard()" class="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors">
                        Shared ✓
                    </button>
                    <button onclick="bridgePass()" class="px-6 py-3 bg-amber-600 text-white rounded-xl font-semibold hover:bg-amber-700 transition-colors">
                        Under Construction
                    </button>
                </div>
                <p class="text-white/50 text-sm">Bridge Pass: Skip if the question feels too personal</p>
            ` : `
                <button onclick="drawCard()" class="px-8 py-4 bg-purple text-white rounded-xl font-semibold text-lg hover:bg-purple/90 transition-colors ${remaining === 0 ? 'opacity-50 cursor-not-allowed' : 'pulse-subtle'}">
                    ${remaining > 0 ? 'Draw Card' : 'Deck Empty'}
                </button>
                ${remaining === 0 || discarded >= 10 ? `
                    <button onclick="navigate('closing')" class="px-6 py-3 bg-white text-purple rounded-xl font-semibold hover:bg-gray-100 transition-colors">
                        The Final Stone →
                    </button>
                ` : ''}
            `}
        </div>

        <div class="mt-8 bg-white/10 rounded-2xl p-4 max-w-2xl mx-auto w-full">
            <h3 class="text-white/80 text-sm font-semibold mb-3 text-center">Shared Lore (${state.sharedLore.length} stories)</h3>
            <div class="flex flex-wrap justify-center gap-2">
                ${state.sharedLore.slice(-8).map(card => `
                    <div class="w-8 h-10 rounded ${getSuitColorClass(card.color)} flex items-center justify-center text-white text-xs font-bold">
                        ${card.rank}
                    </div>
                `).join('')}
                ${state.sharedLore.length === 0 ? '<p class="text-white/40 text-sm">Stories shared will appear here</p>' : ''}
            </div>
        </div>
    </div>`;
        }

        function renderDeckStack() {
            return `
    <div class="relative cursor-pointer" onclick="drawCard()">
        <div class="absolute w-48 h-72 bg-purple/80 rounded-2xl transform rotate-3 translate-x-2"></div>
        <div class="absolute w-48 h-72 bg-purple/90 rounded-2xl transform -rotate-2 -translate-x-1"></div>
        <div class="w-48 h-72 bg-purple rounded-2xl shadow-2xl flex flex-col items-center justify-center glow hover:scale-105 transition-transform">
            <span class="text-white/90 font-display text-xl font-bold">COMMON</span>
            <span class="text-white/90 font-display text-xl font-bold">LORE</span>
            <div class="mt-4 text-white/50 text-sm">${state.deck.length} cards</div>
        </div>
    </div>`;
        }

        function renderCurrentCard(card) {
            const isAction = card.isAction;
            const bgClass = isAction ? getSuitColorClass(card.color) : 'bg-white';
            const textClass = isAction ? 'text-white' : 'text-gray-800';
            const borderClass = isAction ? '' : `border-4 ${getSuitColorClass(card.color, 'border')}`;

            return `
    <div class="w-72 md:w-80 min-h-96 ${bgClass} ${borderClass} rounded-2xl shadow-2xl p-6 fade-in flex flex-col">
        <div class="flex justify-between items-start mb-4">
            <div>
                <span class="text-3xl font-bold ${textClass}">${card.rank}</span>
                <span class="text-2xl ml-1 ${isAction ? 'text-white/80' : getSuitColorClass(card.color, 'text')}">${card.symbol}</span>
            </div>
            ${isAction ? `<span class="text-xs uppercase tracking-wide text-white/70">Action Card</span>` : ''}
        </div>

        ${isAction ? `
            <div class="text-center my-4">
                <h3 class="text-2xl font-display font-bold text-white mb-2">${card.title}</h3>
            </div>
        ` : ''}

        <div class="flex-1 flex items-center">
            <p class="${textClass} text-lg leading-relaxed ${isAction ? 'text-center' : ''}">${card.text}</p>
        </div>

        <div class="mt-4 pt-4 border-t ${isAction ? 'border-white/20' : 'border-gray-200'}">
            <p class="${isAction ? 'text-white/60' : 'text-gray-400'} text-xs text-center">
                ${SUITS[card.suit].name} • ${SUITS[card.suit].theme}
            </p>
        </div>
    </div>`;
        }

        function renderInstructions() {
            const tab = state.instructionsTab;
            const tabs = [
                { id: 'rules', label: 'How to Play' },
                { id: 'cards', label: 'All Cards' },
                { id: 'facilitator', label: "Facilitator's Guide" },
                { id: 'closing', label: 'The Final Stone' },
            ];

            return `
    <div class="min-h-screen p-4 md:p-6">
        <div class="max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <button onclick="navigate('home')" class="text-white/70 hover:text-white flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    Back
                </button>
                <button onclick="startGame()" class="px-4 py-2 bg-purple text-white rounded-lg text-sm font-semibold hover:bg-purple/90 transition-colors">
                    Start Playing
                </button>
            </div>

            <div class="text-center mb-8">
                <h1 class="font-display text-3xl md:text-4xl font-bold text-white mb-2">Common Lore</h1>
                <p class="text-white/60">Complete Instructions & Card Reference</p>
            </div>

            <div class="flex flex-wrap justify-center gap-2 mb-6">
                ${tabs.map(t => `
                    <button onclick="setInstructionsTab('${t.id}')"
                            class="px-4 py-2 rounded-lg font-medium text-sm transition-colors ${tab === t.id ? 'bg-purple text-white' : 'bg-white/10 text-white/70 hover:bg-white/20'}">
                        ${t.label}
                    </button>
                `).join('')}
            </div>

            <div class="bg-cream rounded-3xl p-6 md:p-8 shadow-xl">
                ${tab === 'rules' ? renderInstructionsRules() : ''}
                ${tab === 'cards' ? renderInstructionsCards() : ''}
                ${tab === 'facilitator' ? renderInstructionsFacilitator() : ''}
                ${tab === 'closing' ? renderInstructionsClosing() : ''}
            </div>

            <div class="text-center mt-8 text-white/40 text-sm">
                <p>Format: Standard Poker Size (2.5" × 3.5") • 52 Cards</p>
                <p class="mt-1">Frontier Commons Innovation Lab • International Friendships, Inc.</p>
            </div>
        </div>
    </div>`;
        }

        function renderInstructionsRules() {
            return `
        <h2 class="font-display text-2xl font-bold text-navy mb-6">How to Play</h2>

        <div class="mb-8 p-4 bg-purple/5 rounded-xl">
            <h3 class="font-semibold text-purple mb-2">Objective</h3>
            <p class="text-gray-700">
                To weave individual stories into a <strong>"Shared Lore"</strong> by discovering the universal truths
                that connect our careers, cultures, homes, and wonders.
            </p>
        </div>

        <h3 class="font-semibold text-xl text-navy mb-4">Rules</h3>
        <div class="space-y-4 mb-8">
            ${[
                    { num: '1', title: 'Deal', text: 'Shuffle the deck and deal 5 cards to each player. Place the remaining deck face down in the center.' },
                    { num: '2', title: 'Share', text: 'Going clockwise order, each player chooses a card in their hand and answers the question. Then the card is placed in the discard pile.' },
                    { num: '3', title: 'The "Bridge Pass"', text: 'If a question feels too personal or you aren\'t ready to share, you can say <strong>"Pass"</strong> or <strong>"Under Construction,"</strong> and draw a new card from the deck. Your turn then ends.' },
                    { num: '4', title: 'Aces are Action Cards', text: 'You may play Aces as a special action any time before or after a player answers a question, triggering a special rule for that suit:<br>• <strong>The Referral</strong> (♠) - Nominate another player<br>• <strong>The Shared Table</strong> (♥) - Everyone answers<br>• <strong>The Translator</strong> (♦) - Use a metaphor or native word<br>• <strong>The Experiment</strong> (♣) - Veto or challenge' },
                    { num: '5', title: '"Winning the Game"', text: 'Play until everyone\'s hand is empty. This game is about journey and discovery, not winning!' },
                ].map(rule => `
                <div class="flex gap-4 items-start">
                    <div class="w-8 h-8 rounded-full bg-purple text-white flex items-center justify-center font-bold flex-shrink-0">${rule.num}</div>
                    <div>
                        <h4 class="font-semibold text-navy">${rule.title}</h4>
                        <p class="text-gray-600 text-sm mt-1">${rule.text}</p>
                    </div>
                </div>
            `).join('')}
        </div>

        <h3 class="font-semibold text-xl text-navy mb-4">The Four Suits</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${Object.entries(SUITS).map(([key, suit]) => `
                <div class="flex items-center gap-3 p-4 rounded-xl ${suit.bgLight}">
                    <span class="text-4xl">${suit.symbol}</span>
                    <div>
                        <div class="font-semibold text-navy">${suit.name}</div>
                        <div class="text-sm text-gray-600">${suit.theme}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
        }

        function renderInstructionsCards() {
            return `
        <h2 class="font-display text-2xl font-bold text-navy mb-6">Complete Card Reference</h2>

        ${Object.entries(SUITS).map(([key, suit]) => `
            <div class="mb-10">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b-2 ${getSuitColorClass(suit.color, 'border')}">
                    <span class="text-4xl ${getSuitColorClass(suit.color, 'text')}">${suit.symbol}</span>
                    <div>
                        <h3 class="font-display text-xl font-bold text-navy">${suit.name}</h3>
                        <p class="text-gray-500 text-sm">${suit.theme}</p>
                    </div>
                </div>

                <div class="mb-4 p-4 ${getSuitColorClass(suit.color)} text-white rounded-xl">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">A${suit.symbol}</span>
                        <span class="text-xs uppercase tracking-wide opacity-70">Action Card</span>
                    </div>
                    <div class="font-semibold text-lg mb-1">${suit.action.title}</div>
                    <p class="text-sm opacity-90">${suit.action.text}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${suit.cards.map(card => `
                        <div class="p-3 border-2 ${getSuitColorClass(suit.color, 'border')} rounded-xl bg-white">
                            <span class="font-bold ${getSuitColorClass(suit.color, 'text')}">${card.rank}${suit.symbol}</span>
                            <p class="text-gray-700 text-sm mt-1">${card.text}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('')}
    `;
        }

        function renderInstructionsFacilitator() {
            return `
        <h2 class="font-display text-2xl font-bold text-navy mb-2">Facilitator's Guide</h2>
        <p class="text-gray-500 mb-8">For ISM Staff & Group Leaders</p>

        <!-- Section 1 -->
        <div class="mb-8">
            <h3 class="font-semibold text-lg text-purple mb-3">1. The Opening (Setting the Table)</h3>
            <p class="text-gray-700 mb-4">Before the game, set the tone:</p>

            <div class="bg-purple/5 rounded-xl p-5 space-y-4">
                <div>
                    <span class="font-semibold text-purple">The Invitation:</span>
                    <p class="text-gray-600 italic mt-1">"This isn't an interview or a test. It's a way for us to move from being strangers to being a community. We're here to listen to your stories."</p>
                </div>
                <div>
                    <span class="font-semibold text-purple">The "Oikos" Ethos:</span>
                    <p class="text-gray-600 mt-1">Explain that in many cultures, the "household" (Oikos) is a place of absolute safety and hospitality. This table is an Oikos for the next hour.</p>
                </div>
                <div>
                    <span class="font-semibold text-purple">The Right to Silence:</span>
                    <p class="text-gray-600 mt-1">Remind them of the Bridge Pass. "If a card feels too heavy for today, just say 'Under Construction' and we'll move to the next one."</p>
                </div>
            </div>
        </div>

        <!-- Section 2 -->
        <div class="mb-8">
            <h3 class="font-semibold text-lg text-purple mb-3">2. The "Deepening" Technique (Follow-up Questions)</h3>
            <p class="text-gray-700 mb-4">When a student gives a short answer, don't rush to the next card. Use these "Bridge Expanders" to invite more depth:</p>

            <div class="space-y-3">
                ${[
                    { name: 'The "Tell me more" move', text: '"That sounds significant. Can you tell me more about that moment?"' },
                    { name: 'The "Feeling" move', text: '"When that happened, what was going through your mind?"' },
                    { name: 'The "Global" move', text: '"Do you think most people in your home city feel the same way, or is that unique to your family?"' },
                    { name: 'The "Bridge" move', text: '"How does that [tradition/value] from back home help you navigate your life here in the U.S.?"' },
                ].map((move, i) => `
                    <div class="flex gap-3 items-start bg-white rounded-xl p-4 shadow-sm">
                        <div class="w-6 h-6 rounded-full bg-purple/10 text-purple flex items-center justify-center text-sm font-bold flex-shrink-0">${i + 1}</div>
                        <div>
                            <span class="font-semibold text-navy">${move.name}</span>
                            <p class="text-gray-600 italic text-sm mt-1">${move.text}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>

        <!-- Section 3 -->
        <div>
            <h3 class="font-semibold text-lg text-purple mb-3">3. Handling Specific Suits</h3>

            <div class="space-y-4">
                ${[
                    { suit: '♠', name: 'Spades (Career)', watch: 'Watch for anxiety', note: 'Many students feel immense pressure to succeed for their family.', ask: '"It sounds like you carry a lot of responsibility. Who supports you when the pressure is high?"', color: 'spade' },
                    { suit: '♥', name: 'Hearts (Hospitality)', watch: 'This can trigger homesickness', note: 'If a student gets emotional, don\'t apologize for the question.', ask: '"Thank you for sharing that piece of your heart with us. It\'s a beautiful thing to miss home that much."', color: 'heart' },
                    { suit: '♦', name: 'Diamonds (Culture)', watch: 'Avoid "The Expert" trap', note: 'Don\'t let the conversation become a lecture about a country. Keep it personal.', ask: '"How does that specific legend shape how you see the world?"', color: 'diamond' },
                    { suit: '♣', name: 'Clubs (Science)', watch: 'Encourage "Wonder" over "Argument"', note: 'STEM students often feel they have to choose between their brain and their spirit.', ask: '"What is something you\'ve seen in a lab that felt like poetry?"', color: 'club' },
                ].map(item => `
                    <div class="border-l-4 ${getSuitColorClass(item.color, 'border')} pl-4 py-3 bg-white rounded-r-xl shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="${getSuitColorClass(item.color, 'text')} text-2xl">${item.suit}</span>
                            <span class="font-semibold text-navy">${item.name}</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="font-medium text-gray-800">${item.watch}.</span> ${item.note}
                        </div>
                        <div class="text-sm bg-gray-50 rounded-lg p-3">
                            <span class="font-medium text-gray-700">Pivot to:</span>
                            <span class="text-gray-600 italic"> ${item.ask}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
        }

        function renderInstructionsClosing() {
            return `
        <div class="text-center max-w-2xl mx-auto">
            <h2 class="font-display text-2xl font-bold text-navy mb-6">The Closing</h2>

            <div class="mb-8">
                <h3 class="font-semibold text-xl text-purple mb-4">The "Final Stone"</h3>
                <p class="text-gray-600 mb-6">To end the session, instead of a card, ask everyone to answer one final prompt:</p>

                <div class="bg-purple/10 rounded-2xl p-8 mb-8">
                    <p class="font-display text-xl md:text-2xl text-purple italic leading-relaxed">
                        "What is one thing someone else shared tonight that you'll be thinking about on your walk home?"
                    </p>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="font-semibold text-lg text-navy mb-4">Building Shared Lore</h3>
                <p class="text-gray-600 mb-4">Throughout the game, you're creating connections through:</p>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${[
                    { icon: '♠', name: 'Careers', desc: 'Dreams & ambitions' },
                    { icon: '♥', name: 'Homes', desc: 'Belonging & family' },
                    { icon: '♦', name: 'Cultures', desc: 'Identity & wisdom' },
                    { icon: '♣', name: 'Wonders', desc: 'Science & faith' },
                ].map(pillar => `
                        <div class="bg-white rounded-xl p-4 shadow-sm border-2 border-purple/20">
                            <div class="text-3xl mb-2">${pillar.icon}</div>
                            <div class="font-semibold text-navy text-sm">${pillar.name}</div>
                            <div class="text-xs text-gray-500 mt-1">${pillar.desc}</div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="bg-cream border-2 border-dashed border-purple/30 rounded-xl p-6">
                <p class="text-gray-600 text-sm">
                    <strong>Remember:</strong> This game is about journey and discovery, not winning.
                    The goal is to move from being strangers to being a community—to weave your individual
                    stories into a Shared Lore.
                </p>
            </div>
        </div>
    `;
        }

        function renderClosing() {
            return `
    <div class="min-h-screen flex items-center justify-center p-4 md:p-8">
        <div class="max-w-2xl w-full">
            <div class="bg-cream rounded-3xl p-8 md:p-12 shadow-xl text-center">
                <h1 class="font-display text-3xl md:text-4xl font-bold text-navy mb-4">The Final Stone</h1>
                <p class="text-gray-600 mb-8">Go around the table. Each person answers:</p>

                <div class="bg-purple/5 rounded-xl p-6 mb-8">
                    <p class="font-display text-xl text-purple italic">
                        "What is one thing someone else shared tonight that you'll be thinking about on your walk home?"
                    </p>
                </div>

                <div class="mb-8">
                    <h3 class="text-sm text-gray-500 uppercase tracking-wide mb-4">Your Shared Lore</h3>
                    <div class="flex flex-wrap justify-center gap-2">
                        ${state.sharedLore.map(card => `
                            <div class="w-10 h-12 rounded ${getSuitColorClass(card.color)} flex items-center justify-center text-white text-sm font-bold shadow">
                                ${card.rank}${card.symbol}
                            </div>
                        `).join('')}
                        ${state.sharedLore.length === 0 ? '<p class="text-gray-400">No stories shared yet</p>' : ''}
                    </div>
                    <p class="text-gray-500 text-sm mt-3">${state.sharedLore.length} stories woven into your Shared Lore</p>
                </div>

                <div class="flex flex-col gap-4">
                    <button onclick="resetGame()" class="px-8 py-4 bg-purple text-white rounded-xl font-semibold hover:bg-purple/90 transition-colors">
                        Play Again
                    </button>
                    <button onclick="openFeedback()" class="px-8 py-4 bg-white border-2 border-purple text-purple rounded-xl font-semibold hover:bg-purple hover:text-white transition-colors">
                        Give Feedback
                    </button>
                    <button onclick="navigate('home')" class="text-gray-500 hover:text-purple transition-colors">
                        Return Home
                    </button>
                </div>
            </div>
        </div>
    </div>`;
        }

        // ============== GAME LOGIC ==============
        function navigate(view) {
            state.view = view;
            render();
        }

        function setInstructionsTab(tab) {
            state.instructionsTab = tab;
            render();
        }

        function startGame() {
            state.deck = buildDeck();
            state.currentCard = null;
            state.discardPile = [];
            state.sharedLore = [];
            state.view = 'play';
            startFeedbackTimer();
            render();
        }

        function startFeedbackTimer() {
            if (state.timerStarted) return;
            state.timerStarted = true;
            setTimeout(() => {
                if (!state.feedbackPopupShown) {
                    openFeedback(true);
                }
            }, 5 * 60 * 1000); // 5 minutes
        }

        function openFeedback(isAuto = false) {
            const modal = document.getElementById('feedback-modal');
            modal.classList.remove('hidden');
            state.feedbackPopupShown = true;

            const note = document.getElementById('auto-popup-note');
            if (isAuto) {
                note.classList.remove('hidden');
            } else {
                note.classList.add('hidden');
            }
        }

        function closeFeedback() {
            document.getElementById('feedback-modal').classList.add('hidden');
        }

        function resetGame() {
            startGame();
        }

        function drawCard() {
            if (state.deck.length === 0) return;
            state.currentCard = state.deck.pop();
            render();
        }

        function answerCard() {
            if (state.currentCard) {
                state.discardPile.push(state.currentCard);
                state.sharedLore.push(state.currentCard);
                state.currentCard = null;
            }
            render();
        }

        function bridgePass() {
            if (state.currentCard) {
                state.currentCard = null;
            }
            if (state.deck.length > 0) {
                drawCard();
            } else {
                render();
            }
        }

        // ============== INIT ==============
        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>

</html>